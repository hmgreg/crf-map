<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>CRF Map with Filters</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      display: flex;
      height: 100vh;
    }

    #sidebar {
      width: 340px;
      overflow-y: auto;
      background: #f8f9fa;
      border-right: 1px solid #ccc;
      padding: 1rem;
      box-sizing: border-box;
    }

    #map {
      flex: 1;
    }

    .business {
      margin-bottom: 20px;
      cursor: pointer;
      border-bottom: 1px solid #ddd;
      padding-bottom: 10px;
    }

    .business h3 {
      margin: 0 0 5px;
      font-size: 1.1rem;
    }

    .business p {
      margin: 2px 0;
      font-size: 0.9rem;
    }

    .business a {
      color: #0077cc;
      text-decoration: none;
    }

    .business a:hover {
      text-decoration: underline;
    }

    .filter-buttons {
      margin-bottom: 10px;
    }

    .filter-buttons button {
      margin: 2px;
      padding: 5px 10px;
      border: 1px solid #ccc;
      background: white;
      cursor: pointer;
      font-size: 0.9rem;
    }

    .filter-buttons button.active {
      background-color: #0077cc;
      color: white;
      border-color: #005fa3;
    }

    #searchInput {
      width: 100%;
      padding: 5px;
      margin-bottom: 10px;
      font-size: 0.9rem;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
  </style>
</head>
<body>

  <div id="sidebar">
    <input id="searchInput" placeholder="Search by name, country, email..." />
    <div class="filter-buttons" id="filterButtons"></div>
    <div id="businessList"></div>
  </div>
  <div id="map"></div>

  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <script>
    mapboxgl.accessToken = 'pk.eyJ1IjoiaGFwcHltb25kYXkiLCJhIjoiY21kZXpjNGx2MDhmOTJrb3Bja2ViMW5qcyJ9.rrWtPNbSr1AXBiGQl8AY6A';

    // Email to Bettermode profile mapping
    const memberProfiles = {
      "gary@happymonday.co.nz": "https://crf-demo2025.bettermode.io/member/2yxqdQeKpe",
      "javier.yebenes@fostermoore.com": "https://crf-demo2025.bettermode.io/member/M2BRHV6jt2",
      "justin.hygate@fostermoore.com": "https://crf-demo2025.bettermode.io/member/nqWcIXwmuH",
      "ongchloeee@gmail.com": "https://crf-demo2025.bettermode.io/member/zo3SlrcVxA",
      "richardjohncliffordwilson@gmail.com": "https://crf-demo2025.bettermode.io/member/E8dTThnWLX"
    };
    
    const businesses = [
      {
        name: "Corporations Canada",
        country: "Canada",
        address: "50 Victoria Street, Room C-114, Gatineau, QC J8X 3X1",
        phone: "+1 613 954 3576",
        website: "https://www.ic.gc.ca/eic/site/cd-dgc.nsf/eng/home",
        email: "christiane.gagnon2@ised-isde.gc.ca",
        coords: [-75.7129, 45.4240]
      },
      {
        name: "Germany - Bundesanzeiger Verlag GmbH",
        country: "Germany",
        address: "Amsterdamer StraÃŸe 192, 50735 Cologne, Germany",
        phone: "+49 211 97668179",
        website: "https://www.unternehmensregister.de/ureg/?submitaction=language&language=en",
        email: "service@bundesanzeiger.de",
        coords: [6.9531, 50.9726]
      },
      {
        name: "Happy Monday",
        country: "New Zealand",
        address: "303 Blenheim Road, Christchurch, New Zealand",
        phone: "0212244441",
        website: "https://happymonday.co.nz",
        email: "gary@happymonday.co.nz",
        coords: [172.5781, -43.5317],
        memberUrl: "https://crf-demo2025.bettermode.io/member/2yxqdQeKpe"
      },
      {
        name: "Lesotho",
        country: "Lesotho",
        address: "LNDC Phase II, P.O. Box 747, Maseru 100, Lesotho",
        phone: "+266 2232 6647",
        website: "https://www.obfc.org.ls/home/",
        email: "monahengmaichu@yahoo.com",
        coords: [27.4784, -29.3124]
      }
    ];

    // Attach member URLs to matching businesses by email
    businesses.forEach(b => {
      if (memberProfiles[b.email]) {
        b.memberUrl = memberProfiles[b.email];
      }
    });
    
    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/streets-v12',
      center: [0, 20],
      zoom: 2
    });

    const sidebar = document.getElementById('businessList');
    const searchInput = document.getElementById('searchInput');
    const filterButtons = document.getElementById('filterButtons');

    const uniqueCountries = [...new Set(businesses.map(b => b.country))];
    let selectedCountry = 'All';
    let searchTerm = '';

    const markers = [];

    // Add filter buttons
    function renderFilterButtons() {
      const countries = ['All', ...uniqueCountries];
      filterButtons.innerHTML = '';
      countries.forEach(country => {
        const btn = document.createElement('button');
        btn.textContent = country;
        btn.className = selectedCountry === country ? 'active' : '';
        btn.onclick = () => {
          selectedCountry = country;
          renderBusinesses();
        };
        filterButtons.appendChild(btn);
      });
    }

    // Render business list and markers
    function renderBusinesses() {
      sidebar.innerHTML = '';
      markers.forEach(m => m.remove());
      markers.length = 0;

      const filtered = businesses.filter(b => {
        const matchCountry = selectedCountry === 'All' || b.country === selectedCountry;
        const matchText = Object.values(b).some(val =>
          typeof val === 'string' && val.toLowerCase().includes(searchTerm.toLowerCase())
        );
        return matchCountry && matchText;
      });

      filtered.forEach(biz => {
        const div = document.createElement('div');
        div.className = 'business';
        div.innerHTML = `
          <h3>${biz.name}</h3>
          <p><strong>${biz.country}</strong></p>
          <p>${biz.address}</p>
          <p><a href="mailto:${biz.email}">${biz.email}</a></p>
          <p>Phone: ${biz.phone}</p>
          <p><a href="${biz.website}" target="_blank">Website</a></p>
          ${biz.memberUrl ? `<p><a href="${biz.memberUrl}" target="_blank">View Profile</a></p>` : ''}
        `;
        div.onclick = () => {
          map.flyTo({ center: biz.coords, zoom: 10 });
        };
        sidebar.appendChild(div);

        const marker = new mapboxgl.Marker()
          .setLngLat(biz.coords)
          .setPopup(new mapboxgl.Popup().setHTML(`
            <strong>${biz.name}</strong><br>
            ${biz.address}<br>
            <a href="mailto:${biz.email}">${biz.email}</a><br>
             ${biz.memberUrl ? `<a href="${biz.memberUrl}" target="_blank">View Member Profile</a><br>` : ""}
            <a href="${biz.website}" target="_blank">${biz.website}</a><br>
            Phone: ${biz.phone}
          `))
          .addTo(map);

        markers.push(marker);
      });
    }

    // Search listener
    searchInput.addEventListener('input', () => {
      searchTerm = searchInput.value;
      renderBusinesses();
    });

    renderFilterButtons();
    renderBusinesses();
  </script>

</body>
</html>
